<!doctype html>
<html>

<head>
	<link href="https://fonts.googleapis.com/css?family=Roboto:400,700&display=swap" rel="stylesheet">
	<title>Admin | Unnamed Chat</title>
	<style>
		body {
			font-size: 18px;
			background-color: #3c3c3c;
			color: white;
		}

		body,
		input,
		button {
			font-family: Roboto, sans-serif;
		}

		body,
		html {
			margin: 0px;
			height: 100%;
		}

		input[type=number] {
			width: 60px;
		}

		input {
			text-align: center;
			font-size: 18px;
			outline: 0px;
			border-radius: 5px;
			background-color: #2f2f2f;
			color: white;
			border: 2px solid #232323;
			padding: 5px;
      transition: all 0.3s;
		}

		input:focus {
			border: 2px solid #fda50f;
		}

		.button {
			color: white;
			background-color: #fda50f;
			border-radius: 5px;
			padding: 7px;
			cursor: pointer;
			margin-top: 20px;
			display: inline-block;
		}

		/* remove arrows */
		input::-webkit-outer-spin-button,
		input::-webkit-inner-spin-button {
			-webkit-appearance: none;
			margin: 0;
		}

		#mute {
			top: 50%;
			transform: translateY(-50%);
			text-align: center;
		}

		#sidebar {
			position: absolute;
			left: 0px;
			top: 0px;
			width: 300px;
			height: 100%;
			background-color: #232323;
		}

		#muteLabel {
			display: block;
			height: 21px;
			text-align: center;
			font-size: 18px;
		}

		.tabLabel {
			background-color: #2f2f2f;
			border-radius: 10px;
			margin: 10px;
			padding: 3px;
			text-align: center;
			cursor: pointer;
			border: 2px solid #2f2f2f;
		}

		.tab {
			position: absolute;
			display: none;
			left: 300px;
			right: 0px;
		}

		#ranksList {
			height: calc(100% - 40px);
			width: 200px;
		}

		.label {
			color: grey;
			font-size: 14px;
			width: 200px;
			display: inline-block;
			font-weight: bold;
      margin-left: 13px;
      margin-top: 10px;
		}

		#ranksLabel {
			position: relative;
			cursor: pointer;
		}

		#ranksLabel>span {
			position: absolute;
			right: 25px;
			top: -3px;
			font-size: 18px;
		}

		#ranksLabel:hover {
			color: #888888;
		}

		.rank, .otherAction {
			border-radius: 10px;
			background-color: #2f2f2f;
			border: 2px solid #2f2f2f;
			margin: 10px;
			padding: 3px;
			text-align: center;
			cursor: pointer;
			height: 21px;
			overflow: hidden;
      transition: all 0.3s;
		}

		#rankSettings {
			height: 100%;
			display: inline-block;
			position: absolute;
			top: 0px;
			right: 30%;
			left: 250px;
		}

		#ranks {
			height: 100%;
		}

		#rankSettings>input {
      margin-top: 10px;
			width: calc(100% - 13px) !important;
			text-align: left;
      width: 100%;
		}

		#rankSettings>.label {
			margin-left: 0px;
      width: 100%;
		}

		/* switch */
		.switch {
			position: relative;
			display: inline-block;
			width: 50px;
			height: 24px;
		}

		.switch input {
			opacity: 0;
			width: 0;
			height: 0;
		}

		.slider {
			position: absolute;
			cursor: pointer;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
			background-color: #ccc;
			transition: .4s;
			border-radius: 34px;
		}

		.slider:before {
			position: absolute;
			content: "";
			height: 16px;
			width: 16px;
			left: 4px;
			bottom: 4px;
			background-color: white;
			transition: .4s;
			border-radius: 50%;
		}

		input:checked+.slider {
			background-color: #fda50f;
		}

		input:checked+.slider:before {
			transform: translateX(26px);
		}

		.labelWrap {
			position: absolute;
			right: 0px;
			top: 0px;
		}

		.smallLabel {
      margin-top: 10px;
			position: relative;
			width: 100%;
			display: inline-block;
		}

		#saveButton {
			position: absolute;
			bottom: 10px;
			right: 10px;
		}

		#members {
			right: 30%;
		}

		#userList>div {
			width: 100%;
			border-radius: 10px;
			background-color: #2f2f2f;
			border: 2px solid #2f2f2f;
			margin: 10px;
			padding: 5px;
			text-align: left;
			height: 50px;
			overflow: hidden;
			position: relative;
		}

		#userList>div>span {
			position: absolute;
			left: 195px;
			display: inline-block;
			color: grey;
			font-weight: bold;
			cursor: pointer;
      top: 50%;
      transform: translateY(-50%);
      border: 1px solid grey;
      border-radius: 50%;
      width: 21px;
      height: 21px;
      text-align: center;
		}
    #userList > div > img {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      vertical-align: middle;
      margin-right: 10px;
    }

    .moreActions {
      position: absolute;
      right: 0px;
      top: 50%;
      transform: translateY(-50%);
      width: 21px !important;
      height: 21px !important;
      padding: 6px;
      background-color: #232323;
      cursor: pointer;
    }

		#promoteMenu, #moreActionsMenu {
			width: 250px;
			height: 340px;
			display: none;
			background-color: #232323;
			border-radius: 10px;
			position: absolute;
			left: 200px;
			z-index: 30;
		}

    #moreActionsMenu {
      left: 530px;
    }

		#bodyClick {
			z-index: 29;
			width: 100%;
			height: 100%;
			position: absolute;
			left: 0px;
			top: 0px;
			pointer-events: none;
		}

		.rankTags {
			left: 220px;
			position: absolute;
			display: inline-block;
      overflow: auto;
      top: 50%;
      transform: translateY(-50%);
      width: 350px;
		}

    .rank:hover, .otherAction:hover {
      border: 2px solid #fda50f;
    }

		.rankTag {
      display: inline-block;
			margin: 2.5px 0px 2.5px 10px;
			background-color: #232323;
			border-radius: 5px;
			padding: 3px 5px;
			font-size: 13px;
		}

		.x {
			display: inline-block;
			cursor: pointer;
			font-weight: bold;
			color: grey;
			margin-left: 10px;
		}

    .sideTitle {
      margin: 10px;
      font-weight: bold;
      font-size: 20px;
    }

    #muteBox {
      display: none;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 500px;
      text-align: center;
      padding: 30px;
      border-radius: 10px;
      background-color: #232323;
    }

    .heading {
      font-weight: bold;
      font-size: 25px;
      margin-bottom: 15px;
      text-align: center;
    }

    #reason {
      width: calc(100% -  144px);
    }
	</style>
	<script src="/socket.io/socket.io.js">
	</script>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="Description" content="Unnamed Chat, the superior chat website" />
  <link rel="icon" href="/assets/logo.png" type="image/x-icon"/>
</head>

<body>
	<div id="bodyClick" onclick="this.style.pointerEvents='none'; document.getElementById(hideElement).style.display = 'none'"></div>
	<div id="sidebar">
		<div class="sideTitle">Admin Panel</div>
		<div class="tabLabel" onclick="showTab(0)">Ranks</div>
		<div class="tabLabel" onclick="showTab(1)">Members</div>
	</div>
	<!--permissions-->
	<section id="ranks" class="tab">
		<div id="saveButton" class="button" onclick="saveRankChanges()">Save</div>
		<div class="label" id="ranksLabel">RANKS
			<span>+</span>
    </div>
    <div id="ranksList">
    </div>
    
    <div id="rankSettings">

      <div class="label">DISPLAY</div>
      <input id="rankName"/>

      <span class="smallLabel">Colour
        <div class="labelWrap">
          <input type="color" id="rankColor"/>
        </div>
      </span>

      <div class="label">GENERAL</div>
      <span class="smallLabel">Can Edit Ranks
      <div class="labelWrap">
        <label class="switch">
          <input type="checkbox" id="rankCanEditRanks">
          <span class="slider"></span>
        </label>
      </div>
      </span>

      <div class="label">MODERATION</div>
      <span class="smallLabel">Can Mute
      <div class="labelWrap">
        <label class="switch">
          <input type="checkbox" id="rankCanMute">
          <span class="slider"></span>
        </label>
      </div>
      </span>

    </div>
  </section>
  <!-- user list + actions -->
  <section id="members" class="tab">
    <span class='label'>USER LIST</span>
    <div id="userList">
    </div>
    <div id="promoteMenu"></div>
    <div id="moreActionsMenu">
      <div class="otherAction" onclick="showMuteBox()">Mute</div>
      <div class="otherAction" onclick="alert('no')" >Kick</div>
      <div class="otherAction" onclick="alert('no')" >Ban</div>
    </div>
  </section>
  <div id="muteBox">
    <div class="heading" id="muting">Muting</div>
    <div><input id="reason" placeholder="reason"></div>
    <input type="number" id="years" placeholder="y">
    <input type="number" id="days" placeholder="d">
    <input type="number" id="hours" placeholder="h">
    <input type="number" id="minutes" placeholder="m">
    <div class="button" onclick="mute()">Mute</div>
  </div>
  <script>
    if (location.protocol !== "https:") {
      location.protocol = "https:";
    }
    //todo: CHANGE THIS!
    var server = parseInt(prompt("What Server?"));
    var socket = io();
    var i;
    var shownRank;
    var rankData;
    var shownTab;
    var userList;
    var promoting;
    var userRanks;
    var nextId = 0;
    document.getElementById("rankName").oninput = function() {
      document.getElementsByClassName("rank")[shownRank[0]].innerText = this.value;
    }
    function getCookie(name) {
      var value = "; " + document.cookie;
      var parts = value.split("; " + name + "=");
      if (parts.length == 2) return parts.pop().split(";").shift();
    }
    function saveRankChanges() {
      rankData = {};
      rankData.name = document.getElementById("rankName").value;
      rankData.canMute = document.getElementById("rankCanMute").checked;
      rankData.canEditRanks = document.getElementById("rankCanEditRanks").checked;
      rankData.color = document.getElementById("rankColor").value;
      socket.emit("editRank", getCookie("name"), getCookie("pass"), socket.id, server, shownRank[1], rankData);
      ranksList[shownRank[1]] = rankData;
    }
    function clearCookie(name) {
      document.cookie = name + "=; expires=Thu, 01 Jan 1970 00:00:00 GMT;";
    }
    document.getElementById("ranksLabel").onclick = function() {
      socket.emit("createRank", getCookie("name"), getCookie("pass"), socket.id, server);
      let nextRankPos = document.getElementById("ranksList").children.length;
      document.getElementById("ranksList").innerHTML += "<div class='rank' onclick='showRank(" + nextRankPos + "," + nextId + ")'>New Rank</div>";
      ranksList.push({name: "New Rank", id: nextId, level: nextId, color: "#ffffff"})
      showRank(nextRankPos, + nextId)
      nextId++;
    }
    function showTab(tab) {
      for (i=0; i<document.getElementsByClassName("tab").length; i++) {
        document.getElementsByClassName("tab")[i].style.display = "none";
        document.getElementsByClassName("tabLabel")[i].style.border = "2px solid #2f2f2f";
      }
      document.getElementsByClassName("tabLabel")[tab].style.border = "2px solid #fda50f";
      if (tab === 0) {
        socket.emit("queryRanks", socket.id, server);
      } else if (tab === 1) {
        socket.emit("queryUserList", socket.id, server);
      }
      document.getElementsByClassName("tab")[tab].style.display = "inline-block";
      shownTab = tab;
    }
    function showRank(rank, id) {
      for (i=0; i<document.getElementsByClassName("rank").length; i++) {
        document.getElementsByClassName("rank")[i].style.border = "2px solid #2f2f2f";
      }
      document.getElementsByClassName("rank")[rank].style.border = "2px solid #fda50f";
      document.getElementById("rankName").value = ranksList[rank].name;
      document.getElementById("rankCanMute").checked = ranksList[rank].canMute;
      document.getElementById("rankCanEditRanks").checked = ranksList[rank].canEditRanks;
      document.getElementById("rankColor").value = ranksList[rank].color;
      shownRank = [rank, id];
    }
    if (!getCookie("name") || !getCookie("pass")) {
      window.location.href = "/?redirectTo=admin";
    }
    function mute() {
      time = ((document.getElementById("years").value * 365 * 24 * 60 * 60) +
      (document.getElementById("days").value * 24 * 60 * 60) +
      (document.getElementById("hours").value * 60 * 60) +
      (document.getElementById("minutes").value * 60)) * 1000;
      time += new Date().getTime();
      //round to nearest minute
      time = Math.round(time/60000)*60000;
      socket.emit("mute",
        userList[actionsFor].name,
        time,
        [document.getElementById("years").value,
        document.getElementById("days").value,
        document.getElementById("hours").value,
        document.getElementById("minutes").value],
        getCookie("name"),
        getCookie("pass"),
        socket.id,
        server,
        document.getElementById("reason").value
      );
    }
    function showMuteBox() {
      document.getElementById("muting").innerText = "Muting " + userList[actionsFor].name;
      document.getElementById("bodyClick").style.pointerEvents = "none"; 
      document.getElementById(hideElement).style.display = "none"
      document.getElementById("muteBox").style.display = "block";
    }
    function promote(rank) {
      socket.emit('addRank', userList[promoting].name, rank, getCookie("name"), getCookie("pass"), socket.id, server);
      let rankData2 = ranksList.find(rankData => rankData.id === rank);
      document.getElementsByClassName("rankTags")[promoting].innerHTML += "<div class='rankTag'>" + rankData2.name + "<div class='x' onclick=\"socket.emit('revokeRank','" + userList[promoting] + "'," + rankData2.id + "," + "getCookie('name')," + "getCookie('pass')," + "socket.id, server); this.parentElement.remove()\">&times;</div></div>";
    }
    function promoteMenu(user) {
      document.getElementById("promoteMenu").style.top = 100 + (74 * user) + "px";
      document.getElementById("promoteMenu").style.display = "inline-block";
      hideElement = "promoteMenu";
      document.getElementById("bodyClick").style.pointerEvents = "auto";
      socket.emit("queryRanks", socket.id, server);
      promoting = user;
    }
    function moreActionsMenu(user) {
      document.getElementById("moreActionsMenu").style.top = 100 + (74 * user) + "px";
      document.getElementById("moreActionsMenu").style.display = "inline-block";
      hideElement = "moreActionsMenu";
      document.getElementById("bodyClick").style.pointerEvents = "auto";
      actionsFor = user;
    }
    socket.on("connect", function() {
      socket.emit("queryRanks", socket.id, server);
      socket.emit("queryUserList", socket.id, server);
      showTab(0);
    });
    socket.on("accountSyncError", function() {
      clearCookie("name");
      clearCookie("pass");
      window.location.href = "/";
    });
    socket.on("allAccounts", function(list) {
      document.getElementById("userList").innerHTML = "";
      userList = list;
      for (i = 0; i<list.length; i++) {
        document.getElementById("userList").innerHTML += "<div><img src='/assets/user/" + list[i].name + ".png' />" + list[i].name + "<span onclick=promoteMenu(" + parseInt(i) + ");>+</span><div class='rankTags'></div><img class='moreActions' alt='more actions' src='/assets/more.png' onclick='moreActionsMenu(" + parseInt(i) + ")'/></div>";
        for (f=0; f<list[i].ranks.length; f++) {
          document.getElementsByClassName("rankTags")[i].innerHTML += "<div class='rankTag'>" + list[i].ranks[f].name + "<div class='x' onclick=\"socket.emit('revokeRank','" + list[i].name + "'," + list[i].ranks[f].id + "," + "getCookie('name')," + "getCookie('pass')," + "socket.id, server); this.parentElement.remove()\">&times;</div></div>";
          //end cannot be one string because of chrome bugs
        }
      }
    });
    socket.on("ranks", function(ranks) {
      ranksList = ranks;
      document.getElementById("ranksList").innerText = "";
      for (i=0; i<ranks.length; i++) {
        document.getElementById("ranksList").innerHTML += "<div class='rank' onclick='showRank(" + i + "," + ranks[i].id + ")'>" + ranks[i].name + "</div>"
        nextId = ranks[i].id+1;
      }
      if (ranks.length > 0) {
        showRank(ranks.length-1, ranks[ranks.length-1].id);
      }
      document.getElementById("promoteMenu").innerText = "";
      for (i=0; i<ranks.length; i++) {
        document.getElementById("promoteMenu").innerHTML += "<div class='rank' onclick=promote(" + ranks[i].id + ")>" + ranks[i].name + "</div>";
      }
    });
  </script>
</body>

</html>